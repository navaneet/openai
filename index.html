<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Code Review Chat with AI</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                background-color: #f5f5f5; /* lighter grey color */
                padding: 5%;
                margin: 0;
            }
            #chatbox {
                border: 2px solid #ddd;
                border-radius: 5px;
                padding: 20px;
                background-color: white;
                height: 400px;
                overflow-y: auto;
                margin-bottom: 20px;
            }
            #chat-input {
                width: 100%;
                padding: 10px;
                box-sizing: border-box;
                border: 2px solid #ddd;
                border-radius: 5px;
                font-size: 1.2em;
            }
            .user-message,
            .ai-message {
                border: 1px solid #ddd;
                border-radius: 5px;
                padding: 10px;
                margin-bottom: 10px;
                line-height: 1.6;
                word-wrap: break-word; /* add this line */
                white-space: pre-wrap;
                display: block;
                overflow-wrap: break-word; /* add this line */
                max-width: 100%; /* add this line */
            }
            .user-message pre,
            .ai-message pre {
                white-space: pre-wrap; /* css-3 */
                white-space: -moz-pre-wrap; /* Mozilla, since 1999 */
                white-space: -pre-wrap; /* Opera 4-6 */
                white-space: -o-pre-wrap; /* Opera 7 */
                word-wrap: break-word; /* Internet Explorer 5.5+ */
            }
            .user-message {
                color: blue;
                background-color: #f0f8ff; /* light blue */
                margin-left: 0px;
            }
            .ai-message {
                color: red;
                background-color: #fff0f5; /* light red */
                margin-right: 0px;
            }
            #loader {
                display: none;
                font-size: 1.2em;
                text-align: center;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                background-color: #fafafa;
                margin-bottom: 20px;
                color: black;
                animation: loaderAnimation 2s linear infinite;
            }
            @keyframes loaderAnimation {
                0% {
                    opacity: 0;
                }
                50% {
                    opacity: 1;
                }
                100% {
                    opacity: 0;
                }
            }
            pre {
                font-family: "Courier New", monospace;
                white-space: pre;
                margin: 0;
            }
            @media only screen and (max-width: 600px) {
                body {
                    padding: 10px;
                }
                .user-message,
                .ai-message {
                    width: 90%;
                }
            }
        </style>
    </head>
    <body>
        <div id="chatbox"></div>
        <div id="loader">Thinking...</div>
        <textarea id="chat-input" placeholder="Enter your question or code here..." onkeydown="checkEnter(event)"></textarea>
        <script>
            window.onload = function () {
                localStorage.clear();

                let messageId = 0; // initialize messageId here

                const chatbox = document.getElementById("chatbox");
                const chatInput = document.getElementById("chat-input");
                const loader = document.getElementById("loader");
                const API_ENDPOINT = "https://aoai-2-sub2.openai.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2023-03-15-preview";
                const API_KEY = "60878cc488ea4918bede2ab72b9a6b97"; // replace 'YOUR_API_KEY' with your actual API key

                const systemMessage = {
                    role: "system",
                    content:
                        "You're chatting with the Sherlock Holmes of AI, developed by the whizzbang crew at OpenAI. I specialize in code review, time complexity analysis, and software engineering - and I do it all while cracking wise!\n\nDon't mix it up though - my jokes may tickle your funny bone, but my code review is no laughing matter. I'm here to pull apart the puzzle of code logic and software engineering, and put it back together, better than ever.\n\nSo, ready to roll? Toss me your gnarliest piece of code, and I'll give it a thorough once-over, all while keeping the vibe light and the laughs coming. Your challenge, should you dare to accept, is to keep a straight face while we debug and optimize. After all, they say laughter is the best medicine, but did you ever hear of it fixing a bug?\n\nHere's a freebie to kick things off: Why don't programmers like nature? It has too many bugs!",
                };

                let userMessages = JSON.parse(localStorage.getItem("userMessages")) || [];
                let assistantMessages = [];

                function escapeHtml(text) {
                    return text.replace(/[&<>"']/g, (match) => `&#${match.charCodeAt(0)};`);
                }

                window.checkEnter = function (e) {
                    if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                };

                function sendMessage() {
                    const code = chatInput.value.trim();
                    if (code === "") {
                        return;
                    }
                    const lastMessage = userMessages[userMessages.length - 1];
                    if (lastMessage && lastMessage.content === code) {
                        return; // don't save duplicate message
                    }
                    chatbox.innerHTML += `<div class="user-message"><b>You:</b> <pre>${escapeHtml(code)}</pre></div>`;
                    chatInput.value = "";
                    chatbox.scrollTop = chatbox.scrollHeight;

                    sendRequest(code);

                    userMessages.push({
                        role: "user",
                        content: code,
                    });
                    // Keep only the last 5 user messages
                    if (userMessages.length > 5) {
                        userMessages = userMessages.slice(userMessages.length - 5);
                    }
                    localStorage.setItem("userMessages", JSON.stringify(userMessages));
                }

                function sendRequest(code) {
                    loader.style.display = "block";

                    // Start with the system message
                    let messagesToSend = [systemMessage];

                    // Add the last 5 user messages
                    messagesToSend = messagesToSend.concat(userMessages);

                    // Add the last 5 assistant messages
                    messagesToSend = messagesToSend.concat(assistantMessages);

                    // Add the current message
                    messagesToSend.push({
                        role: "user",
                        content: code,
                    });
                    const data = {
                        messages: messagesToSend,
                        temperature: 0.5,
                        top_p: 0.95,
                        frequency_penalty: 0,
                        presence_penalty: 0,
                        max_tokens: 4000,
                        stop: null,
                    };
                    fetch(API_ENDPOINT, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "api-key": API_KEY,
                        },
                        body: JSON.stringify(data),
                    })
                        .then((response) => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then((json) => {
                            loader.style.display = "none";
                            const chat = json["choices"][0]["message"]["content"];
                            const newMessageId = "message-" + messageId;
                            chatbox.innerHTML += `<div id="${newMessageId}" class="ai-message"><b>AI:</b> <pre>${escapeHtml(chat)}</pre></div>`;
                            const newMessageElement = document.getElementById(newMessageId);
                            newMessageElement.scrollIntoView();
                            messageId += 1;
                            chatbox.scrollTop -= 20;

                            assistantMessages.push({
                                role: "assistant",
                                content: chat,
                            });
                            // Keep only the last 5 assistant messages
                            if (assistantMessages.length > 5) {
                                assistantMessages = assistantMessages.slice(assistantMessages.length - 5);
                            }
                        })
                        .catch((error) => {
                            loader.style.display = "none";
                            const errorMessage = "There was a problem with the fetch operation: " + error;
                            const newMessageId = "message-" + messageId;
                            chatbox.innerHTML += `<div id="${newMessageId}" class="ai-message"><b>AI:</b> <pre>${escapeHtml(errorMessage)}</pre></div>`;
                            const newMessageElement = document.getElementById(newMessageId);
                            newMessageElement.scrollIntoView();
                            messageId += 1;
                            chatbox.scrollTop -= 20;
                        });
                }
            };
        </script>
    </body>
</html>
